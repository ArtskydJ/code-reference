var form        = document.querySelector('.phpdocumentor-search'),
    searchField = document.querySelector('.phpdocumentor-search input[type="search"');

// Init autoComplete.
var autoCompletejs = new autoComplete({
    data: {
        src: async function() {
            // Add loading message.
            searchField.setAttribute('placeholder', 'Loading...');

            // Fetch data.
            var source = await fetch(searchParams.searchIndex),
                data   = await source.json();

            searchField.setAttribute('placeholder', 'Search');

            return data;
        },
        key: ['name'],
        cache: false
    },
    sort: function(a, b) {
        if (a.match < b.match) {
            return -1;
        }
        if (a.match > b.match) {
            return 1;
        }
        return 0;
    },
    placeHolder: 'Search',
    selector: '#autoComplete',
    highlight: true,
    threshold: 1,
    searchEngine: 'loose',
    maxResults: 20,
    resultsList: {
        render: true,
        container: function(source) {
            source.classList.add('phpdocumentor-search-results__entries');
        },
        destination: document.querySelector('.phpdocumentor-search-results'),
        position: 'afterend',
        element: 'ul'
    },
    resultItem: {
        content: function(data, source) {
            source.classList.add('phpdocumentor-search-results__entry');
            source.innerHTML += '<h3><a href="' + data.value.url + '">' + data.match + "</a></h3>\n";
            source.innerHTML += '<small>' + data.value.fqsen + "</small>\n";
            source.innerHTML += '<span class="phpdocumentor-summary">' + data.value.summary + '</span>';
        },
        element: 'li'
    },
    noResults: function() {
        var result = document.createElement('li');
        result.setAttribute('class', 'no-result');
        result.setAttribute('tabindex', '1');
        result.innerHTML = 'No results were found. Try a different search term.';
        document.querySelector('#autoComplete_list').appendChild(result);
    }
});

// Display search field.
form.classList.add('phpdocumentor-search--enabled');
form.classList.add('phpdocumentor-search--active');
searchField.setAttribute('placeholder', 'Search');
searchField.removeAttribute('disabled');

// Close search results with ESC.
window.addEventListener('keyup', function(event) {
    if (event.code === 'Escape') {
        document
            .querySelector('.phpdocumentor-search-results__entries')
            .innerHTML = '';

        searchField.value = '';
    }
});
